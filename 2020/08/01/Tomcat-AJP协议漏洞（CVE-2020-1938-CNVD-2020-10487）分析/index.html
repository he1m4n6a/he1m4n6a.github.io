<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="He1m4n6a的博客">
    <meta name="keyword"  content="腾讯">
    <link rel="shortcut icon" href="/img/favicon.ico">

    <title>
        
        Tomcat AJP协议漏洞（CVE-2020-1938 / CNVD-2020-10487）分析 - He1m4n6a的博客 | He1m4n6a&#39;s Blog
        
    </title>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/aircloud.css">
    <link rel="stylesheet" href="/css/gitment.css">
    <!--<link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">-->
    <link href="//at.alicdn.com/t/font_620856_pl6z7sid89qkt9.css" rel="stylesheet" type="text/css">
    <!-- ga & ba script hoook -->
    <script></script>
</head>

<body>

<div class="site-nav-toggle" id="site-nav-toggle">
    <button>
        <span class="btn-bar"></span>
        <span class="btn-bar"></span>
        <span class="btn-bar"></span>
    </button>
</div>

<div class="index-about">
    <i> 路漫漫其修远兮，吾将上下而求索。 </i>
</div>

<div class="index-container">
    
    <div class="index-left">
        
<div class="nav" id="nav">
    <div class="avatar-name">
        <div class="avatar ">
            <img src="/img/avatar.jpg" />
        </div>
        <div class="name">
            <i>He1m4n6a</i>
        </div>
    </div>
    <div class="contents" id="nav-content">
        <ul>
            <li >
                <a href="/">
                    <i class="iconfont icon-shouye1"></i>
                    <span>主页</span>
                </a>
            </li>
            <li >
                <a href="/tags">
                    <i class="iconfont icon-biaoqian1"></i>
                    <span>标签</span>
                </a>
            </li>
            <li >
                <a href="/archive">
                    <i class="iconfont icon-guidang2"></i>
                    <span>存档</span>
                </a>
            </li>
            <li >
                <a href="/about/">
                    <i class="iconfont icon-guanyu2"></i>
                    <span>关于</span>
                </a>
            </li>
            
            <li>
                <a id="search">
                    <i class="iconfont icon-sousuo1"></i>
                    <span>搜索</span>
                </a>
            </li>
            
        </ul>
    </div>
    
        <div id="toc" class="toc-article">
    <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#前言"><span class="toc-text">前言</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#影响版本"><span class="toc-text">影响版本</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#修复参考"><span class="toc-text">修复参考</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#环境准备"><span class="toc-text">环境准备</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#基础知识简介"><span class="toc-text">基础知识简介</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#文件读取漏洞分析"><span class="toc-text">文件读取漏洞分析</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#文件包含漏洞分析"><span class="toc-text">文件包含漏洞分析</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#总结"><span class="toc-text">总结</span></a></li></ol>
</div>
    
</div>


<div class="search-field" id="search-field">
    <div class="search-container">
        <div class="search-input">
            <span id="esc-search"> <i class="icon-fanhui iconfont"></i></span>
            <input id="search-input"/>
            <span id="begin-search">搜索</span>
        </div>
        <div class="search-result-container" id="search-result-container">

        </div>
    </div>
</div>

        <div class="index-about-mobile">
            <i> 路漫漫其修远兮，吾将上下而求索。 </i>
        </div>
    </div>
    
    <div class="index-middle">
        <!-- Main Content -->
        


<div class="post-container">
    <div class="post-title">
        Tomcat AJP协议漏洞（CVE-2020-1938 / CNVD-2020-10487）分析
    </div>

    <div class="post-meta">
        <span class="attr">发布于：<span>2020-08-01 23:58:30</span></span>
        
        <span class="attr">标签：/
        
        <a class="tag" href="/tags/#tomcat ajp" title="tomcat ajp">tomcat ajp</a>
        <span>/</span>
        
        <a class="tag" href="/tags/#文件上传" title="文件上传">文件上传</a>
        <span>/</span>
        
        <a class="tag" href="/tags/#文件下载" title="文件下载">文件下载</a>
        <span>/</span>
        
        
        </span>
        <span class="attr">访问：<span id="busuanzi_value_page_pv"></span>
</span>
</span>
    </div>
    <div class="post-content ">
        <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>AJP（Apache JServ Protocol）是定向包协议。因为性能原因，使用二进制格式来传输可读性文本。WEB服务器通过TCP连接和 SERVLET容器连接。</p>
<h1 id="影响版本"><a href="#影响版本" class="headerlink" title="影响版本"></a>影响版本</h1><p>tomcat 6</p>
<p>tomcat7 ~ 7.0.100</p>
<p>tomcat8 ~ 8.5.51</p>
<p>tomcat9 ~ 9.0.31</p>
<h1 id="修复参考"><a href="#修复参考" class="headerlink" title="修复参考"></a>修复参考</h1><p>1.<a href="https://github.com/apache/tomcat/commit/4c933d80e340b4a841a672060351b2190b326782" target="_blank" rel="noopener">默认在<code>conf/server.xml</code>中禁用AJP连接器</a>；</p>
<p>2.<a href="https://github.com/apache/tomcat/commit/0e8a50f0a5958744bea1fd6768c862e04d3b7e75" target="_blank" rel="noopener">强制AJP协议默认监听本地环回地址，而不是0.0.0.0</a>；</p>
<p>3.<a href="https://github.com/apache/tomcat/commit/9ac90532e9a7d239f90952edb229b07c80a9a3eb" target="_blank" rel="noopener">若使用AJP协议，设置secretRequired属性为true，强制配置secret来设置AJP协议认证凭证</a>；</p>
<p>4.<a href="https://github.com/apache/tomcat/commit/64fa5b99442589ef0bf2a7fcd71ad2bc68b35fad" target="_blank" rel="noopener">配置属性白名单，若向AJP连接器发送任意未被识别的属性，都会响应403</a>;</p>
<h1 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h1><ul>
<li><p>tomcat 8.5.46：<a href="http://archive.apache.org/dist/tomcat/tomcat-8/v8.5.46/src/apache-tomcat-8.5.46-src.zip" target="_blank" rel="noopener">http://archive.apache.org/dist/tomcat/tomcat-8/v8.5.46/src/apache-tomcat-8.5.46-src.zip</a></p>
</li>
<li><p>IEDA搭建过程可以参考这篇Paper：<a href="https://blog.csdn.net/qq_35262405/article/details/101780644" target="_blank" rel="noopener">Tomcat源码编译</a></p>
</li>
<li><p>POC: <a href="https://github.com/YDHCUI/CNVD-2020-10487-Tomcat-Ajp-lfi" target="_blank" rel="noopener">https://github.com/YDHCUI/CNVD-2020-10487-Tomcat-Ajp-lfi</a></p>
</li>
</ul>
<h1 id="基础知识简介"><a href="#基础知识简介" class="headerlink" title="基础知识简介"></a>基础知识简介</h1><p><strong>(1) Tomcat Connector(连接器)</strong></p>
<p>首先来说一下Tomcat的Connector组件，Connector组件的主要职责就是负责<strong>接收客户端连接</strong>和<strong>客户端请求的处理加工</strong>。每个Connector会监听一个指定端口，分别负责对请求报文的解析和响应报文组装，解析过程封装Request对象，而组装过程封装Response对象。</p>
<p>举个例子，如果把Tomcat比作一个城堡，那么Connector组件就是城堡的城门，为进出城堡的人们提供通道。当然，可能有多个城门，每个城门代表不同的通道。而Tomcat默认配置启动，开了两个城门（通道）：一个是监听8080端口的<strong>HTTP Connector</strong>，另一个是监听8009端口的<strong>AJP Connector</strong>。</p>
<p>Tomcat组件相关的配置文件是在<code>conf/server.xml</code>，配置文件中每一个元素都对应了Tomcat的一个组件（可以在配置文件中找到如下两项，配置了两个Connector组件）：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- Define a non-SSL/TLS HTTP/1.1 Connector on port 8080 --&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"> <span class="tag">&lt;<span class="name">Connector</span> <span class="attr">port</span>=<span class="string">"8080"</span> <span class="attr">protocol</span>=<span class="string">"HTTP/1.1"</span> <span class="attr">connectionTimeout</span>=<span class="string">"20000"</span> <span class="attr">redirectPort</span>=<span class="string">"8443"</span> /&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"> .....</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"> <span class="comment">&lt;!-- Define an AJP 1.3 Connector on port 8009 --&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line"> <span class="tag">&lt;<span class="name">Connector</span> <span class="attr">port</span>=<span class="string">"8009"</span> <span class="attr">protocol</span>=<span class="string">"AJP/1.3"</span> <span class="attr">redirectPort</span>=<span class="string">"8443"</span> /&gt;</span></span></pre></td></tr></table></figure>

<p>HTTP Connector很好理解，通过浏览器访问Tomcat服务器的Web应用时，使用的就是这个连接器；</p>
<p>AJP Connector是通过AJP协议和一个Web容器进行交互。在将Tomcat与其他HTTP服务器（一般是Apache ）集成时，就需要用到这个连接器。AJP协议是采用二进制形式代替文本形式传输，相比HTTP这种纯文本的协议来说，效率和性能更高，也做了很多优化。</p>
<p>显然，浏览器只支持HTTP协议，并不能直接支持AJP协议。所以实际情况是，通过Apache的proxy_ajp模块进行反向代理，暴露成http协议（8009端口）给客户端访问，大致如下图所示：</p>
<p><img src="/images/tomcat_ajp/1.png" alt="image-20200813223619814"></p>
<p><strong>(2) Servlet(服务程序)</strong></p>
<p>Servlet意为服务程序，也可简单理解为是一种用来处理网络请求的一套规范。主要作用是给上级容器(Tomcat)提供doGet()和doPost()等方法，其生命周期实例化、初始化、调用、销毁受控于Tomcat容器。有个例子可以很好理解：想象一下，在一栋大楼里有非常多特殊服务者Servlet，这栋大楼有一套智能系统帮助接待顾客引导他们去所需的服务提供者（Servlet）那接受服务。这里顾客就是一个个请求，特殊服务者就是Servlet，而这套智能系统就是Tomcat容器。</p>
<p>Tomcat中Servlet的配置是在<code>conf/web.xml</code>。Tomcat默认配置定义了两个servlet，分别为<code>DefaultServlet</code>和<code>JspServlet</code>：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- The default servlet for all web applications, that serves static    --&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">&lt;!-- resources.  It processes all requests that are not mapped to other   --&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">&lt;!-- servlets with servlet mappings. --&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">    <span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>default<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">        <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>org.apache.catalina.servlets.DefaultServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">        ......</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">        ......</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">    <span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">&lt;!-- The JSP page compiler and execution servlet, which is the mechanism  --&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">&lt;!-- used by Tomcat to support JSP pages.  Traditionally, this servlet    --&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">&lt;!-- is mapped to the URL pattern "*.jsp". --&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">    <span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>jsp<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">        <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>org.apache.jasper.servlet.JspServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">        ......</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">        ......</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">    <span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line">    ......</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line">    ......</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">&lt;!-- The mapping for the default servlet --&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">22</span></pre></td><td class="code"><pre><span class="line">    <span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">23</span></pre></td><td class="code"><pre><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>default<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">24</span></pre></td><td class="code"><pre><span class="line">        <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">25</span></pre></td><td class="code"><pre><span class="line">    <span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">26</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">27</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">&lt;!-- The mappings for the JSP servlet --&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">28</span></pre></td><td class="code"><pre><span class="line">    <span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">29</span></pre></td><td class="code"><pre><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>jsp<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">30</span></pre></td><td class="code"><pre><span class="line">        <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>*.jsp<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">31</span></pre></td><td class="code"><pre><span class="line">        <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>*.jspx<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">32</span></pre></td><td class="code"><pre><span class="line">    <span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span></pre></td></tr></table></figure>

<p>所有的请求进入tomcat，都会流经servlet。由注释可以很明显看出，如果没有匹配到任何应用指定的servlet，那么就会流到默认的servlet(即<code>DefaultServlet</code>)，而<code>JspServlet</code>负责处理所有JSP文件的请求。</p>
<p><strong>(3) Tomcat内部处理请求流程</strong></p>
<p>Tomcat内部处理请求的流程第一次看可能觉得会有点复杂。网上很多分析tomcat内部架构的文章，看几篇就能明白个大概了。网上看到张图，简单修改重新绘制了下，介绍一下Tomcat内部处理HTTP请求的流程，便于理解后续的漏洞分析：</p>
<p><img src="/images/tomcat_ajp/2.png" alt="image-20200813223746705"></p>
<ol>
<li>用户点击网页内容，请求被发送到本机端口8080，被Connector获得（<strong>Connector中的Processor用于封装Request，Adapter用于将封装好的Request交给Container</strong>）。</li>
<li>Connector把该请求交给Container中的Engine来处理，并等待Engine的回应。</li>
<li>Engine获得请求localhost/test/index.jsp，匹配所有的虚拟主机Host。</li>
<li>Engine匹配到名为localhost的Host（即使匹配不到也把请求交给该Host处理，因为该Host被定义为该Engine的默认主机），名为localhost的Host获得请求/test/index.jsp，匹配它所拥有的所有的Context。Host匹配到路径为/test的Context（如果匹配不到就把该请求交给路径名为” “的Context去处理）。</li>
<li>path=”/test”的Context获得请求/index.jsp，在它的mapping table中寻找出对应的Servlet。Context匹配到URL PATTERN为<em>.jsp的Servlet，对应于JspServlet类（*</em>匹配不到指定Servlet的请求对应DefaultServlet类**）。</li>
<li>Wrapper是最底层的容器，负责管理一个Servlet。构造HttpServletRequest对象和HttpServletResponse对象，作为参数调用JspServlet的doGet()或doPost()，执行业务逻辑、数据存储等程序。</li>
<li>Context把执行完之后的HttpServletResponse对象返回给Host。</li>
<li>Host把HttpServletResponse对象返回给Engine。</li>
<li>Engine把HttpServletResponse对象返回Connector。</li>
<li>Connector把HttpServletResponse对象返回给客户Browser。</li>
</ol>
<h1 id="文件读取漏洞分析"><a href="#文件读取漏洞分析" class="headerlink" title="文件读取漏洞分析"></a>文件读取漏洞分析</h1><p>首先在<code>webapps/manager/WEB-INF/</code>新建<code>aaa</code>文件，文件内容如下：</p>
<figure class="highlight jsp"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">&lt;%Runtime.getRuntime().exec(<span class="keyword">new</span> String[]&#123;<span class="string">"open"</span>,<span class="string">"/Applications/Calculator.app"</span>&#125;);%&gt;</span></pre></td></tr></table></figure>

<p>修改poc的<code>perform_request</code>:</p>
<p><img src="/images/tomcat_ajp/3.png" alt="image-20200813004826524"></p>
<p>运行poc：<code>python3 CNVD-2020-10487-Tomcat-Ajp-lfi.py 127.0.0.1 -p 8009 -f WEB-INF/aaa</code></p>
<p><strong>调试过程：</strong></p>
<p>首先将断点打到<code>AjpProcessor</code>类的<code>service()</code>方法。</p>
<p><img src="/images/tomcat_ajp/4.png" alt="image-20200813003209247"></p>
<p>运行poc：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">python3 CNVD-2020-10487-Tomcat-Ajp-lfi.py 127.0.0.1 -p 8009 -f WEB-INF/aaa</span></pre></td></tr></table></figure>

<p>然后一步步调试，随后跟入<code>prepareRequest()</code>方法。该方法解析请求，将相关属性匹配到该request的属性里。</p>
<p><img src="/images/tomcat_ajp/5.png" alt="image-20200813004116390"></p>
<p>在<code>DefaultServlet</code>类中<code>service</code>中打断点，继续运行到此方法，并跟入<code>super.service</code>。</p>
<p><img src="/images/tomcat_ajp/6.png" alt="image-20200813004346683"></p>
<p>在<code>HttpServlet</code>类<code>service</code>下断点，跟进<code>doGet</code></p>
<p><img src="/images/tomcat_ajp/7.png" alt="image-20200813005446780"></p>
<p>跟进<code>doGet</code>中的<code>serveResource</code>方法，跟进<code>serveResource</code>中的<code>getRelativePath</code>的方法。</p>
<p><img src="/images/tomcat_ajp/8.png" alt="image-20200813010443159"></p>
<p>这三个参数对应的值是：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> String INCLUDE_REQUEST_URI = <span class="string">"javax.servlet.include.request_uri"</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> String INCLUDE_PATH_INFO = <span class="string">"javax.servlet.include.path_info"</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> String INCLUDE_SERVLET_PATH = <span class="string">"javax.servlet.include.servlet_path"</span>;</span></pre></td></tr></table></figure>

<p>也是poc中我们可控输入的值（看下源码就知道）。</p>
<p>跳出<code>getRelateivePath</code>继续跟进，跟进到<code>resources.getResource(path)</code>，进入<code>getResource</code>。调用了<code>validate</code>函数，继续跟进这函数。<code>validate</code>方法内主要调用了<code>normalize</code>方法对path参数进行校验。</p>
<p><img src="/images/tomcat_ajp/9.png" alt="image-20200813011317566"></p>
<p>经过<code>validate()</code>方法校验后，<code>getResources()</code>方法随后的一系列操作就通过路径读取到了资源。最后通过<code>getOutputStream()</code>方法获得<code>ServletOutputStream</code>的实例，利用<code>ServletOutputStream.write()</code>向输出流写入返回内容。</p>
<h1 id="文件包含漏洞分析"><a href="#文件包含漏洞分析" class="headerlink" title="文件包含漏洞分析"></a>文件包含漏洞分析</h1><p>修改poc的<code>perform_request</code>:</p>
<p><img src="/images/tomcat_ajp/10.png" alt="image-20200813014147337"></p>
<p>运行poc：<code>python3 CNVD-2020-10487-Tomcat-Ajp-lfi.py 127.0.0.1 -p 8009 -f WEB-INF/aaa</code></p>
<p><strong>调试过程：</strong></p>
<p>断点打到<code>JspServlet</code>类的<code>service()</code>方法，先将servlet_path和path_info拼接在一起，赋值给jspUri（外部可控）。</p>
<p><img src="/images/tomcat_ajp/11.png" alt="image-20200812235438362"></p>
<p>随后进入<code>serviceJspFile()</code>方法，将/aaa带入Tomcat加载和处理jsp的流程里，处理流程如下：</p>
<p><img src="../images/tomcat_ajp/12.png" alt="image-20200813000438082"></p>
<p>简单理解就是传入的<code>aaa</code>被当成jsp文件编译执行。带入了Tomcat处理jsp的处理流程，将jsp(<code>aaa</code>)转义成Servlet源代码.java(<code>aaa.java</code>)，将Servlet源代码.java编译成Servlet类.class(<code>aaa.class</code>)，Servlet类执行后，响应结果至客户端。</p>
<p><img src="/images/tomcat_ajp/13.png" alt="image-20200813000749396"></p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>AJP协议请求中的三个属性<code>request_uri</code>、<code>path_info</code>、<code>servlet_path</code>用户可控，如果请求的<code>servlet</code>不存在则</p>
<p>调用<code>DefaultServlet</code>导致文件读取漏洞。如果请求是<code>.jsp</code>结尾，则调用<code>JspServlet</code>导致文件包含漏洞（RCE）。</p>
<p><strong>参考</strong>：</p>
<p><a href="https://github.com/YDHCUI/CNVD-2020-10487-Tomcat-Ajp-lfi" target="_blank" rel="noopener">https://github.com/YDHCUI/CNVD-2020-10487-Tomcat-Ajp-lfi</a></p>
<p><a href="https://xz.aliyun.com/t/7683" target="_blank" rel="noopener">https://xz.aliyun.com/t/7683</a></p>
<p><a href="https://www.cnblogs.com/r00tuser/p/12343153.html" target="_blank" rel="noopener">https://www.cnblogs.com/r00tuser/p/12343153.html</a></p>
<p><a href="https://blog.csdn.net/flyfrommath/article/details/85039030" target="_blank" rel="noopener">https://blog.csdn.net/flyfrommath/article/details/85039030</a></p>
<p><a href="https://www.cnblogs.com/jajian/p/9410844.html" target="_blank" rel="noopener">https://www.cnblogs.com/jajian/p/9410844.html</a></p>

        
            <div class="donate-container">
    <div class="donate-button">
        <button id="donate-button">赞赏</button>
    </div>
    <div class="donate-img-container hide" id="donate-img-container">
        <img id="donate-img" src="" data-src="/img/donate.jpg">
        <p> 感谢鼓励 </p>
    </div>
</div>
        
        <br />
        <div id="comment-container">
        </div>
        <div id="disqus_thread"></div>

        <div id="lv-container">
        </div>

    </div>
</div>

    </div>
</div>


<footer class="footer">
    <ul class="list-inline text-center">
        
        

        

        

        

        

    </ul>
    
    <p>
        <span>/</span>
        
        <span><a href="https://github.com/he1m4n6a" target="_blank" rel="noopener">github</a></span>
        <span>/</span>
        
        <span><a href="https://weibo.com/u/1736968374" target="_blank" rel="noopener">weibo</a></span>
        <span>/</span>
        
        <span><a href="#">wechat</a></span>
        <span>/</span>
        
    </p>
    
    <p>
        <span id="busuanzi_container_site_pv">
            <span id="busuanzi_value_site_pv"></span>PV
        </span>
        <span id="busuanzi_container_site_uv">
            <span id="busuanzi_value_site_uv"></span>UV
        </span>
        Created By <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a>  Theme <a href="https://github.com/aircloud/hexo-theme-aircloud" target="_blank" rel="noopener">AirCloud</a></p>
</footer>




</body>

<script>
    // We expose some of the variables needed by the front end
    window.hexo_search_path = "search.json"
    window.hexo_root = "/"
    window.isPost = true
</script>
<script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>
<script src="/js/index.js"></script>
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>


    <script>
        /**
         *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
         *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
        */
        if( '' || '')
        var disqus_config = function () {
            this.page.url = '';  // Replace PAGE_URL with your page's canonical URL variable
            this.page.identifier = ''; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
        };

        (function() { // DON'T EDIT BELOW THIS LINE
            var d = document, s = d.createElement('script');
            s.src = 'https://airclouds-blog.disqus.com/embed.js';
            s.setAttribute('data-timestamp', +new Date());
            (d.head || d.body).appendChild(s);
        })();
    </script>



</html>
